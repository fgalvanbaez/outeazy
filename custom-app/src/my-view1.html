<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="shared-styles.html">


<dom-module id="my-view1">
  <template>

    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      /* Prevent the text contents of draggable elements from being selectable. */
      [draggable] {
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        /* Required to make elements draggable in old WebKit */
        -khtml-user-drag: element;
        -webkit-user-drag: element;
      }

    </style>

    <!--<div class="card">
      <paper-icon-button id="delete" icon="delete"></paper-icon-button>
      <paper-icon-button id="save" icon="save"></paper-icon-button>
      <a>Last saved: </a><a id="lastsaved"></a>
    </div>-->


    <!--<div class="card">
      <paper-input id="taskInput" label="Introduzca tarea">
        <paper-icon-button icon="mail" prefix></paper-icon-button>
        <paper-icon-button icon="mail" suffix></paper-icon-button>-->
      <!--</paper-input>
      <paper-icon-button id="btnAgregar" icon="polymer" class="btnAgregar" value="Agregar tarea" type="button">
      <div id="numTasks" class="circle"></div>
      <div id="visitors" class="circle"></div>
    </div>-->

    <div id="lista" class=""></div>

  </template>

  <!-- Script principal de Polymer -->
  <script>
    class MyView1 extends Polymer.Element {

      static get is() { return 'my-view1'; }

      static get properties() {
        return {
          session: {
            type: Object,
            observer: "_sessionChanged",
          },
          taskList: {
            type: Array,
            observer: "_taskListChanged",
          },
        }
      }

      static get observers() {
        return [
        ];
      }

      constructor(){
        super();
        console.log(this.localName + '#' + 'constructor');
      }

      ready(){
        super.ready();
        console.log(this.localName + '#' + 'ready');
      }

      connectedCallback() {
        super.connectedCallback();
        console.log(this.localName + '#' + 'connectedCallback');
      }

      disconnectedCallback(){
        super.disconnectedCallback();
        console.log(this.localName + '#' + 'disconnectedCallback');
      }

      _generateTask(key) {
        //Convierto str a JSON object
        //var myJSON = JSON.parse(args[0][1]["task"+x]);
        var myJSON = JSON.parse(this.taskList[key]);
        //alert(args[0][1]["task"+x])
        var idTask = myJSON.node.id;
        //convierto el JSON object en un nodo del DOM
        var nodo = domJSON.toDOM(myJSON);

        var index = document.createElement('div');
        index.setAttribute('class', 'circle');
        index.innerText = idTask.replace("task", "");
        nodo.appendChild(index);

        //Creo bot칩n para eliminar la tarea
        var btn = document.createElement("paper-icon-button");
        btn.id = "del" + idTask;
        btn.icon = 'delete';
        //btn.value = "Eliminar";
        //btn.type = "button";

        //Necesito bindear la funcion del listener para
        //que se reconozca la variable session
        btn.addEventListener('click', this._handleDelTask.bind(this));

        //A침ado el bot칩n al nodo
        nodo.appendChild(btn);

        //A침ado el nodo al DOM
        this.$.lista.appendChild(nodo);
      }

      _handleDelTask(evt) {
        alert(evt.target.id)
        var correctID = evt.target.id.replace("del", "");
        alert("Eliminando tarea "+ correctID);
        this.session.call("io.crossbar.app.deltask", [correctID])
          .then(this.session.log);
      }

      //observers
      _sessionChanged() {
        this.session.log("Session open my-view1: "+ this.session.id);
        //alert("La sesion esta creada aqui");
        //this._taskListChanged();
        //this._createPropertyObserver('taskList', '_taskListChanged', true);
      }

      _taskListChanged(session, taskList) {
        console.log("Me llego algo: "+Object.keys(this.taskList).length);
        var ntasks = Object.keys(this.taskList).length;
        while (lista.firstChild) {
          lista.removeChild(lista.firstChild);
        }
        var x;
        for (x=0; x<ntasks; x++) { //Lo recorro asi para mostrarlos en orden
          this._generateTask("task"+x);
        }
      }
    }

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>
