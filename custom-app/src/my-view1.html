<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="shared-styles.html">


<dom-module id="my-view1">
  <template>

    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      /* Prevent the text contents of draggable elements from being selectable. */
      [draggable] {
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        /* Required to make elements draggable in old WebKit */
        -khtml-user-drag: element;
        -webkit-user-drag: element;
      }

    </style>

    <!--<div class="card">
      <paper-icon-button id="delete" icon="delete"></paper-icon-button>
      <paper-icon-button id="save" icon="save"></paper-icon-button>
      <a>Last saved: </a><a id="lastsaved"></a>
    </div>-->


    <!--<div class="card">
      <paper-input id="taskInput" label="Introduzca tarea">
        <paper-icon-button icon="mail" prefix></paper-icon-button>
        <paper-icon-button icon="mail" suffix></paper-icon-button>-->
      <!--</paper-input>
      <paper-icon-button id="btnAgregar" icon="polymer" class="btnAgregar" value="Agregar tarea" type="button">
      <div id="numTasks" class="circle"></div>
      <div id="visitors" class="circle"></div>
    </div>-->

    <div id="lista" class=""></div>

    <!--<paper-dialog id=dialog modal>
      <paper-input id="tTask" on-keydown="_checkForEnter" label="Introduzca tarea" required auto-validate error-message="Campo requerido!!" >
      <div class="buttons">
        <paper-icon-button icon="icons:close" dialog-dismiss>Cancel</paper-icon-button>
        <paper-icon-button icon="icons:add" dialog-confirm autofocus>Tap me to close</paper-icon-button>
      </div>
    </paper-dialog>-->

  </template>

  <!-- Script principal de Polymer -->
  <script>
    class MyView1 extends Polymer.Element {

      static get is() { return 'my-view1'; }

      static get properties() {
        return {
          session: {
            type: Object,
            observer: "_sessionChanged",
          },
          taskList: {
            type: Array,
            observer: "_taskListChanged",
          },
        }
      }

      static get observers() {
        return [
        ];
      }

      constructor(){
        super();
        console.log(this.localName + '#' + 'constructor');
      }

      ready(){
        super.ready();
        console.log(this.localName + '#' + 'ready');
      }

      connectedCallback() {
        super.connectedCallback();
        console.log(this.localName + '#' + 'connectedCallback');
      }

      disconnectedCallback(){
        super.disconnectedCallback();
        console.log(this.localName + '#' + 'disconnectedCallback');
      }

      _generateTask(key) {
        //Convierto str a JSON object
        //var myJSON = JSON.parse(args[0][1]["task"+x]);
        //var myJSON = JSON.parse(this.taskList[key]);
        //alert(args[0][1]["task"+x])
        //var idTask = key.replace('task', '');
        //convierto el JSON object en un nodo del DOM
        //var nodo = domJSON.toDOM(myJSON);

        var node = document.createElement("div");
        var myStr = this.taskList[key];

        /*var index = document.createElement('div');
        index.setAttribute('class', 'circle');
        index.innerText = key.replace('task', '');
        node.appendChild(index);*/

        var valor = document.createTextNode(myStr);
        node.appendChild(valor);

        // Asigno atributos
        node.setAttribute("id", key);
        node.setAttribute("class", "card");
        node.setAttribute("draggable", "true");

        //Creo botón para editar la tarea
        var btn = document.createElement("paper-icon-button");
        btn.id = "edit" + key;
        btn.icon = 'icons:create';
        btn.addEventListener('tap', this._handleEditTask.bind(this));
        node.appendChild(btn);

        //Creo botón para eliminar la tarea
        btn = document.createElement("paper-icon-button");
        btn.id = "del" + key;
        btn.icon = 'icons:delete';
        btn.addEventListener('tap', this._handleDelTask.bind(this));
        node.appendChild(btn);

        //Añado el nodo al DOM
        this.$.lista.appendChild(node);
      }

      _handleEditTask(evt) {

        //alert('#mod'+evt.target.id);
        //evt.target.icon = "icons:close";

        /*var edits = document.querySelector('.edit');
        if (edits.length > 0) {
          this.$.lista.removeChild(edits);
        }*/

        //evt.target.addEventListener('tap', this._handleDelModTask.bind(this));

        var fab = document.createElement('paper-fab');
        fab.id = evt.target.id.replace('edit', '');
        fab.slot="suffix";
        fab.icon="icons:add";
        fab.mini=true;
        fab.addEventListener('tap', this._postTask.bind(this));

        var input = document.createElement('paper-input');
        input.id = "mod"+evt.target.id;
        input.value = evt.target.parentNode.innerText;
        input.appendChild(fab);
        input.setAttribute('class', 'card edit');

        //this.$.lista.removeChild(evt.target.parentNode);
        evt.target.parentNode.parentNode.insertBefore(input, evt.target.parentNode.nextSibling);

      }

      _handleDelModTask(evt) {
        this.$.lista.removeChild(document.querySelector('#mod'+evt.target.id));
      }

      _postTask(evt) {

        //alert("Modificando tarea "+evt.target.id);
        if (evt.target.parentNode.value) {
          console.log(evt.target.parentNode.value);
          console.log(evt.target.parentNode.id);
          //var nuevaTarea = document.createElement("div");

          var myStr = evt.target.parentNode.value;

          /*Genera una tarea un la envia al backend, el backend se encarga
          de hacer un publish con la nueva tarea incluida esta misma sesion*/
          this.session.call("io.crossbar.app.createtask", [evt.target.id, myStr])
            .then(this.session.log);
            /*.then(this._handleTask.bind(this), this.session.log)
            .catch(this._handleError.bind(this));*/

          //this.$.tTask.value = "";
        }

      }

      _handleDelTask(evt) {
        //alert(evt.target.id)
        var correctID = evt.target.id.replace("del", "");
        //alert("Eliminando tarea "+ correctID);
        this.session.call("io.crossbar.app.deltask", [correctID])
          .then(this.session.log);
      }

      //observers
      _sessionChanged() {
        this.session.log("Session open my-view1: "+ this.session.id);
        //alert("La sesion esta creada aqui");
        //this._taskListChanged();
        //this._createPropertyObserver('taskList', '_taskListChanged', true);
      }

      _taskListChanged(session, taskList) {
        console.log("Me llego algo: "+Object.keys(this.taskList).length);
        var ntasks = Object.keys(this.taskList).length;
        while (this.$.lista.firstChild) {
          this.$.lista.removeChild(this.$.lista.firstChild);
        }
        var x;
        for (x=0; x<ntasks; x++) { //Lo recorro asi para mostrarlos en orden
          this._generateTask("task"+x);
        }
      }
    }

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>
